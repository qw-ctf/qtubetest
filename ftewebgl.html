<!doctype html>
<html lang="en-us">
  <head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name=viewport content="width=device-width, initial-scale=1">
	<title>FTE QuakeWorld</title>
	<style>
	@font-face {
            font-family: 'ComicShannsNerdFont-Regular';
            src: url('ComicShannsNerdFont-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
	html,body { 
		background-color:#000000;
		color:#808080;
		margin:0;
		padding:0;
		font-family: "ComicShannsNerdFont-Regular";
		text-align: right;
	}
	.emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
	div.emscripten { text-align: center; padding:0; margin: 0;}
	/* the canvas *must not* have any border or padding, or mouse coords will be wrong */
	canvas.emscripten { border: 0px none; width:100%; height:90%; padding:0; margin: 0;}
	</style>
  </head>
  <body ondrop="gotdrop(event);" ondragover="event.preventDefault()">
	<div class="emscripten" id="status">Please allow/unblock our javascript to play.</div>
	<div id="dropzone" ondrop="gotdrop(event);" ondragover="event.preventDefault()" hidden=1>Drop Zone</div>
	<button type="button" onclick="begin()" id="begin" hidden=1>Click To Begin!</button>
	<div class="emscripten">
		<progress value="0" max="100" id="progress" hidden=1></progress>  
	</div>
	<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" hidden=1></canvas>
	<table style="width: 100%; border-collapse: collapse">
		<tr>
			<td colspan="2" id="levelname" style="text-align: left">
			</td>
		</tr>
		<tr>
			<td id="info" style="width: 50%; vertical-align: top;"></td>
			<td id="timers" style="width: 50%; vertical-align: top;"></td>
		</tr>
	</table>
	<script type='text/javascript'>
// connect to canvas
var Module = {
	files:
	{	//these can be arraybuffers(you'll need a helper to define those) or promises(fte will block till they complete), or strings (which will be interpretted as urls and downloaded before any C code is run)
		//note that the code below will skip the file-drop prompt if there's any files specified here (or there's a #foo.fmf file specified)
		"default.fmf": "default.fmf",
		"id1/data.pk3": "qw/data.pk3",
		"id1/config.cfg": "id1/config.cfg",
		"id1/fragfile.dat": "id1/fragfile.dat",
		"id1/locs/dm2.loc": "id1/locs/dm2.loc",
		"id1/maps/dm2.bsp": "id1/maps/dm2.bsp",
		"id1/maps/e2m2.bsp": "id1/maps/e2m2.bsp",
		"id1/4on4_polz_vs_]sr[[dm2]20240402-2152.mvd": "qw/4on4_polz_vs_]sr[[dm2]20240402-2152.mvd",
		"id1/nqr_050322_dqm_vs_la_round3_e2m2.mvd.gz": "qw/nqr_050322_dqm_vs_la_round3_e2m2.mvd.gz",
		"id1/qhlan_final_lw_v_bl_4of5_ctf_blue_vs_red[e2m2]20221118-2221.mvd.gz": "qw/qhlan_final_lw_v_bl_4of5_ctf_blue_vs_red[e2m2]20221118-2221.mvd.gz",
		"id1/skins/2base.pcx": "qw/skins/2base.pcx",
		"id1/skins/2baseboth.pcx": "qw/skins/2baseboth.pcx",
		"id1/skins/2basepent.pcx": "qw/skins/2basepent.pcx",
		"id1/skins/2basequad.pcx": "qw/skins/2basequad.pcx",
		"ctf/fte.cfg": "qw/fte.cfg",
		"qw/fte.cfg": "qw/fte.cfg",
		//"qw/particles/balltexture.png": "qw/ball.png", 
	},
	print: function(msg)
	{	//stdout...
		console.log(msg);
	},
	printErr: function(text)
	{	//stderr...
		console.log(text);
	},
	canvas: document.getElementById('canvas'),	//for webgl to attach to
	setStatus: function(text)
	{	//gets spammed some prints during startup. blame emscripten.
		if (Module.setStatus.interval)
			clearInterval(Module.setStatus.interval);
		var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
		var statusElement = document.getElementById('status');
		var progressElement = document.getElementById('progress');
		if (m) {
			text = m[1];
			progressElement.value = parseInt(m[2])*100;
			progressElement.max = parseInt(m[4])*100;
			progressElement.hidden = false;
		} else {
			progressElement.value = null;
			progressElement.max = null;
			progressElement.hidden = true;
		}
		statusElement.innerHTML = text;
		statusElement.hidden = text.length==0;
	},
//	preRun: [],
	totalDependencies: 0,
	monitorRunDependencies: function(left)
	{	//progress is progress...
		this.totalDependencies = Math.max(this.totalDependencies, left);
		Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
	},
//	onRuntimeInitialized: function(){},
	postRun:
	[	//each of these are called after main was run. we should have our mainloop set up now
		function()
		{
			if (Module["sched"] === undefined)
			{	//our main function failed to set up the main loop. ie: main didn't get called. panic.
				alert("Unable to initialise. You may need to restart your browser. If you get this often and inconsistently, consider using a 64bit browser instead.");
				Module.setStatus("Initialisation Failure");
			}
			else
			{
				setTimeout(update_info, 1000);
			}
		}
	],
};
function update_info()
{
	console.log("update_info");
	var text = new TextDecoder();

	var client = Module.getClientState();
	var fragstats = Module.getFragStats();

        var level = document.getElementById("levelname");
        levelname.innerHTML = client.getLevelNamePlain();

	var table = document.createElement("table");
	table.style.width = "100%";
	var row = table.insertRow()
	row.insertCell().textContent = "Team";
	row.insertCell().textContent = "Name";
	row.insertCell().textContent = "Location";
	row.insertCell().textContent = "Frags";
	row.insertCell().textContent = "Suicides";
	row.insertCell().textContent = "Kills";
	row.insertCell().textContent = "Teamkills";

	for (var i = 0; i < client.allocated_client_slots; i++) {
		var player = client.getPlayer(i);
		var name = player.getName();
		if (name.length == 0 ||Â player.spectator) {
			continue;
		}

		var totals = fragstats.getClientTotals(i);

		var row = table.insertRow();

		row.insertCell().textContent = player.getTeamPlain();
		row.insertCell().textContent = player.getNamePlain();
		var cell = row.insertCell()
		cell.style.width = "10em";
		cell.textContent = client.getPlayerLocation(i);
		row.insertCell().textContent = player.frags;
		row.insertCell().textContent = totals.suicides;
		row.insertCell().textContent = totals.kills;
		row.insertCell().textContent = totals.teamkills;
	}

	var timers = document.createElement("table");
	timers.style.width = "100%";
	var row = timers.insertRow();
	row.insertCell().textContent = "ETA";
	row.insertCell().textContent = "Item";
	row.insertCell().textContent = "Location";
	try {
		var items = []
		for (var it = client.getItemTimers(); it != null; it = it.getNext()) {
			console.log(client.time, it.entnum, it.start, it.end, it.duration, "t:", it.getType(), it.getTypeName(), it.getLocation());
			items.push([it.end, (it.end - client.time).toFixed(1) + "s", it.getTypeName(), it.getLocation()]);
		} 
		items.sort((a, b) => {
			return a[0] - b[0];
		});
		for (var i = 0; i < items.length; i++) {
			var row = timers.insertRow();
			row.insertCell().textContent = items[i][1];
			row.insertCell().textContent = items[i][2];
			row.insertCell().textContent = items[i][3];
		}
	} catch (e) {
	}


	var info_cell = document.getElementById("info");
	info_cell.innerHTML = "";
	info_cell.appendChild(table);

	var timers_cell = document.getElementById("timers");
	timers_cell.innerHTML = "";
	timers_cell.appendChild(timers);


	setTimeout(update_info, 1000);
}
function begin()
{
	if (Module.began)
		return;
	Module.began = true;
	document.getElementById('dropzone').hidden = true;
	document.getElementById('begin').hidden = true;
	Module.setStatus('Downloading...');

	// make a script. do it the hard way for the error.
	var s = document.createElement('script');
	// set it up
	s.setAttribute('src',"ftewebgl.js");
	s.setAttribute('type',"text/javascript");
	s.setAttribute('charset',"utf-8");
	s.addEventListener('error', function() {alert("Oh noes! we got an error!"); Module.setStatus("Unable to download engine javascript");}, false);
	// add to DOM
	document.head.appendChild(s);
}

//stuff to facilitate our drag+drop filesystem support
function fixupfilepath(fname, path)
{	//we just have a filename, try to guess where to put it.
	if (path != "")
		return path+fname;	//already has a path. use it. this allows people to drag+drop gamedirs.
	var ext = fname.substr(fname.lastIndexOf('.') + 1);
	if (ext == 'fmf' || ext == 'kpf')	//these are the only files that really make sense in the root.
		return fname;
	if (ext == 'bsp' || ext == 'map' || ext == 'lit' || ext == 'lux')
		return "id1/maps/" + fname;	//bsps get their own extra subdir
	return "id1/" + fname;	//probably a pak. maybe a cfg, no idea really.
}
function showfiles()
{	//print the pending file list in some pretty way
	if (Module.began)
		return;
	Module.setStatus('');
	document.getElementById('dropzone').hidden = false;
	document.getElementById('begin').hidden = false;
	var nt = "Drag gamedirs or individual package files here to make them available!<br/>Active Files:<br/><pre>";
	var keys = Object.keys(Module.files);
	for(var i = 0; i < keys.length; i++)
	{
		if (Module.files[keys[i]] instanceof ArrayBuffer)
		{
			var sz = Module.files[keys[i]].byteLength;
			if (sz > 512*1024)
				sz = (sz / (1024*1024)) + "mb";
			else if (sz > 512)
				sz = (sz / 1024) + "kb";
			else
				sz = (sz) + " bytes";
			nt += "    " + keys[i] + " ("+sz+")<br/>";
		}
		else
			nt += "    " + keys[i] + "<br/>";
	}
	nt += "</pre>("+keys.length+" files)";
	document.getElementById('dropzone').innerHTML = nt;
}
function scanfiles(item,path)
{	//for directory drops
	if (item.isFile)
	{
		item.file(function(f)
		{
			let n = fixupfilepath(f.name, path);
			Module.files[n]=f.arrayBuffer();	//actually a promise...
			Module.files[n].then(buf=>{Module.files[n]=buf;showfiles();});	//try and resolve it now.
    	});
	}
	else if (item.isDirectory)
	{
		// Get folder contents
		var dirReader = item.createReader();
		dirReader.readEntries(function(entries)
		{
			for (var i=0; i<entries.length; i++)
				scanfiles(entries[i], path + item.name + "/");
		});
	}
}
function gotdrop(ev)
{	//user drag+dropped something. 
	ev.preventDefault();
	for (var i = 0; i < ev.dataTransfer.items.length; i++)
		if (ev.dataTransfer.items[i].webkitGetAsEntry)
		{
			var d = ev.dataTransfer.items[i].webkitGetAsEntry();
			if (d)
				scanfiles(d, "");
		}
		else if (ev.dataTransfer.items[i].kind === 'file')
		{
			var f = ev.dataTransfer.items[i].getAsFile();
			var n = fixupfilepath(f.name);
			Module.files[n]=f.arrayBuffer();	//actually a promise...
			Module.files[n].then(buf=>{Module.files[n]=buf;showfiles();});	//try and resolve it now.
		}
	showfiles();
}
if (window.location.hash != "" || Object.keys(Module.files).length)
	begin();		//if the url has a #foo.fmf then just begin instantly, 
else
	showfiles();	//otherwise show our lame file dropper and wait for the user to click 'go'.
    </script>      
  </body>
</html>
